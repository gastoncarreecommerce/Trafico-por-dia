<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sesiones por hora – Comparativo</title>
  <style>
    :root{--bg:#0b0e13;--card:#131824;--ink:#e6ecff;--muted:#9bb1ff;--accent:#7aa2ff;--ok:#62d394;--warn:#ffb65c}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .controls{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:10px;background:#0e1320;border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px}
    .chip input[type=file]{inline-size:220px}
    .chip label{font-size:12px;color:var(--muted)}
    .chip input[type=checkbox]{transform:scale(1.1)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:3fr 1.3fr}}
    .panel{padding:16px}
    .meta{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{background:#0b1020;border:1px solid rgba(255,255,255,.06);padding:12px;border-radius:12px}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:700}
    .kpi .delta.positive{color:var(--ok)}
    .kpi .delta.negative{color:#ff7b7b}
    .footer{opacity:.7;font-size:12px;margin-top:12px}
    .chart-wrap{height:420px;display:block}
    canvas{width:100%!important;height:100%!important;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));border-radius:12px}
    .btn{appearance:none;background:linear-gradient(135deg, #2BCCF5, #3B36A0);color:white;border:0;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted)}
    a{color:var(--accent)}
    select, input[type=number]{background:#0e1320;border:1px solid rgba(255,255,255,.12);color:var(--ink);padding:8px 10px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sesiones por hora – Comparativo automático (Excel)</h1>
      <div class="controls">
        <div class="chip"><label for="file">Subí tu Excel (.xlsx):</label><input id="file" type="file" accept=".xlsx,.xls" /></div>
        <div class="chip"><label for="sheet">Hoja:</label><select id="sheet"></select></div>
        <div class="chip"><label for="type">Tipo de gráfico</label><select id="type"><option value="bar">Barras</option><option value="line">Líneas</option></select></div>
        <div class="chip"><label for="stacked">Apiladas</label><input id="stacked" type="checkbox" /></div>
        <div class="chip"><label for="labels">Mostrar etiquetas</label><input id="labels" type="checkbox" checked /></div>
        <div class="chip"><label for="fmt">Formato</label><select id="fmt"><option value="normal">Normal</option><option value="compact">Compacto (K/M)</option></select></div>
        <div class="chip"><label for="minval">Umbral mínimo</label><input id="minval" type="number" value="0" min="0" step="1" style="width:90px" /></div>
        <button class="btn" id="download" disabled>Descargar PNG</button>
      </div>
    </header>

    <div class="grid">
      <div class="card panel">
        <div class="chart-wrap"><canvas id="chart"></canvas></div>
        <div class="footer hint">Detecta automáticamente archivos GA4 (ES o EN). También funciona con columnas simples “Hora/Hour” y “Sesiones/Sessions”.</div>
      </div>
      <div class="card panel">
        <div class="meta">
          <div class="kpi"><div class="t">Total A</div><div class="v" id="kpiA">–</div></div>
          <div class="kpi"><div class="t">Total B</div><div class="v" id="kpiB">–</div></div>
          <div class="kpi"><div class="t">Δ % (A vs B)</div><div class="v"><span id="kpiDelta" class="delta">–</span></div></div>
          <div class="kpi"><div class="t">Hora pico</div><div class="v" id="kpiPeak">–</div></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script>
  const $ = (s)=>document.querySelector(s);
  const fileInput=$('#file'),sheetSel=$('#sheet'),chartEl=$('#chart'),btnPng=$('#download');
  const typeSel=$('#type'),stackedCb=$('#stacked'),labelsCb=$('#labels'),fmtSel=$('#fmt'),minInput=$('#minval');
  let workbook, chart, parsed;

  const toInt = (x)=>{const s=String(x||'').replace(/[^0-9]/g,'');return s?parseInt(s,10):NaN;};
  const formatNumber=(v,mode='normal')=>{
    if(mode==='compact'&&Intl?.NumberFormat)return new Intl.NumberFormat('es-AR',{notation:'compact',maximumFractionDigits:1}).format(v);
    return Number(v).toLocaleString('es-AR');
  };

  fileInput.addEventListener('change',async e=>{
    const f=e.target.files[0]; if(!f) return;
    const data=await f.arrayBuffer(); workbook=XLSX.read(data);
    sheetSel.innerHTML=''; workbook.SheetNames.forEach((name,i)=>{const o=document.createElement('option');o.value=name;o.textContent=name;if(i===0)o.selected=true;sheetSel.appendChild(o);});
    renderFromSheet(sheetSel.value);
  });

  ['change'].forEach(ev=>{
    sheetSel.addEventListener(ev,()=>renderFromSheet(sheetSel.value));
  });
  [typeSel,stackedCb,labelsCb,fmtSel,minInput].forEach(el=>el.addEventListener('change',()=>drawChart()));
  btnPng.addEventListener('click',()=>{if(!chart)return;const url=chart.toBase64Image();const a=document.createElement('a');a.href=url;a.download='sesiones_por_hora.png';a.click();});

  function renderFromSheet(name){
    const ws=workbook.Sheets[name];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    parsed=parseGA4(rows)||parseSimple(rows);
    if(!parsed){alert('No pude detectar columnas válidas.');return;}
    drawChart(); updateKPIs(parsed); btnPng.disabled=false;
  }

  function parseGA4(rows){
    const isChange=s=>['% de cambio','% change'].includes(String(s||'').toLowerCase().trim());
    const isRange=s=>/\d{4}/.test(s)&&/-/.test(s);
    const h=new Set(),A={},B={};let lA=null,lB=null;
    for(let i=0;i<rows.length;i++){
      const r=rows[i]||[],c0=String(r[0]||'').trim(),c1=String(r[1]||'').trim();
      if(/^\d+$/.test(c0)&&isChange(c1)){
        const hr=parseInt(c0,10),r1=rows[i+1]||[],r2=rows[i+2]||[];
        const d1=String(r1[1]||r1[0]||''),d2=String(r2[1]||r2[0]||''),v1=toInt(r1[2]||r1[3]),v2=toInt(r2[2]||r2[3]);
        if(isRange(d1)&&isRange(d2)){if(!lA){lA=d1;lB=d2;}A[hr]=v1;B[hr]=v2;h.add(hr);}
      }
    }
    if(h.size===0)return null;
    const labels=[...h].sort((a,b)=>a-b);
    return{labels,seriesLabels:[lA||'Fecha A',lB||'Fecha B'],datasets:[labels.map(x=>A[x]||0),labels.map(x=>B[x]||0)]};
  }

  function parseSimple(rows){
    let idx=-1,ih=-1,is=-1;
    for(let i=0;i<Math.min(20,rows.length);i++){
      const r=rows[i].map(x=>String(x).toLowerCase());
      ih=r.findIndex(v=>v==='hora'||v==='hour');is=r.findIndex(v=>v.includes('sesion')||v.includes('session'));
      if(ih>-1&&is>-1){idx=i;break;}
    }
    if(idx===-1)return null;
    const labels=[],data=[];
    for(let i=idx+1;i<rows.length;i++){
      const r=rows[i];if(!r.length)continue;const h=r[ih];const v=toInt(r[is]);if(!h||isNaN(v))continue;
      labels.push(Number(h));data.push(v);
    }
    if(!labels.length)return null;
    return{labels:labels.sort((a,b)=>a-b),seriesLabels:['Sesiones'],datasets:[data]};
  }

  function drawChart(){
    if(chart)chart.destroy();
    const wrap=document.querySelector('.chart-wrap');chartEl.height=Math.max(320,wrap.clientHeight||420);
    const type=typeSel.value,stacked=stackedCb.checked,show=labelsCb.checked,fmt=fmtSel.value,minv=Math.max(0,Number(minInput.value||0));
    const labels=parsed.labels.map(h=>String(h).padStart(2,'0'));
    const clean=a=>a.map(v=>Number.isFinite(Number(v))?Number(v):0);
    const datasets=parsed.datasets.map((arr,i)=>({label:parsed.seriesLabels[i]||`Serie ${i+1}`,data:clean(arr),tension:.35,fill:stacked&&type==='line',borderWidth:2}));
    
    // Auto-padding superior según valores máximos (anti-recorte)
    const maxVal=Math.max(...parsed.datasets.flat());
    const topPad=maxVal>20000?60:35;

    const cfg={
      type,
      data:{labels,datasets},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'index',intersect:false},
        layout:{padding:{top:topPad,left:20,right:20,bottom:15}},
        plugins:{
          legend:{labels:{color:'#cfe0ff',font:{size:13}}},
          tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${formatNumber(ctx.parsed.y??ctx.raw,fmt)}`}},
          datalabels: show ? {
            formatter:(v)=>v>=minv?formatNumber(v,fmt):'',
            anchor:'end',align:'top',offset:4,clamp:true,clip:false,
            color:'#e6ecff',font:{weight:'600',size:10},padding:2
          }: {display:false}
        },
        scales:{
          x:{ticks:{color:'#9bb1ff'},stacked:stacked&&type==='bar'},
          y:{ticks:{color:'#9bb1ff'},grid:{color:'rgba(255,255,255,.08)'},stacked:stacked&&type==='bar'}
        }
      },
      plugins:[ChartDataLabels]
    };
    chart=new Chart(chartEl.getContext('2d'),cfg);
  }

  function updateKPIs(p){
    const a=p.datasets[0].reduce((s,v)=>s+(v||0),0);
    const b=p.datasets[1]?p.datasets[1].reduce((s,v)=>s+(v||0),0):0;
    const d=b>0?((a/b)-1)*100:0;
    const base=p.datasets[0];const peak=base.indexOf(Math.max(...base));
    $('#kpiA').textContent=a.toLocaleString('es-AR');
    $('#kpiB').textContent=b.toLocaleString('es-AR');
    const kd=$('#kpiDelta');kd.textContent=isFinite(d)?d.toFixed(2)+'%':'–';kd.className='delta '+(d>=0?'positive':'negative');
    $('#kpiPeak').textContent=String(p.labels[peak]).padStart(2,'0')+':00';
  }
  </script>
</body>
</html>
