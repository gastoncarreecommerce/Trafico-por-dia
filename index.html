<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sesiones por hora – Comparativo</title>
  <style>
    :root{--bg:#0b0e13;--card:#131824;--ink:#e6ecff;--muted:#9bb1ff;--accent:#7aa2ff;--ok:#62d394;--warn:#ffb65c}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:10px;background:#0e1320;border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px}
    .chip input[type=file]{inline-size:220px}
    .chip label{font-size:12px;color:var(--muted)}
    .chip input[type=checkbox]{transform:scale(1.1)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:3fr 1.3fr}}
    .panel{padding:16px}
    .meta{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{background:#0b1020;border:1px solid rgba(255,255,255,.06);padding:12px;border-radius:12px}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:700}
    .kpi .delta.positive{color:var(--ok)}
    .kpi .delta.negative{color:#ff7b7b}
    .footer{opacity:.7;font-size:12px;margin-top:12px} .chart-wrap{height:420px; display:block} canvas{width:100%!important;height:100%!important;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));border-radius:12px}
    canvas{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));border-radius:12px}
    .btn{appearance:none;background:linear-gradient(135deg, #2BCCF5, #3B36A0);color:white;border:0;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted)}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sesiones por hora – Comparativo automático (Excel)</h1>
      <div class="controls">
        <div class="chip">
          <label for="file">Subí tu Excel (.xlsx):</label>
          <input id="file" type="file" accept=".xlsx,.xls" />
        </div>
        <div class="chip">
          <label for="sheet">Hoja:</label>
          <select id="sheet"></select>
        </div>
        <div class="chip">
          <label for="stacked">Barras apiladas</label>
          <input id="stacked" type="checkbox" />
        </div>
        <div class="chip">
          <label for="type">Tipo de gráfico</label>
          <select id="type">
            <option value="bar">Barras</option>
            <option value="line">Líneas</option>
          </select>
        </div>
        <button class="btn" id="download" disabled>Descargar PNG</button>
      </div>
    </header>

    <div class="grid">
      <div class="card panel">
        <div class="chart-wrap"><canvas id="chart"></canvas></div>
        <div class="footer hint">Detecta automáticamente el formato exportado de GA4 “Sesiones x hora”: filas con <em>Hora → % de cambio</em> + dos filas con fechas (Ej. <em>29 oct-29 oct 2025</em> y <em>22 oct-22 oct 2025</em>). También intenta un fallback si tu archivo trae columnas simples <code>Hora</code> y <code>Sesiones</code>.</div>
      </div>

      <div class="card panel">
        <div class="meta">
          <div class="kpi"><div class="t">Total fecha A</div><div class="v" id="kpiA">–</div></div>
          <div class="kpi"><div class="t">Total fecha B</div><div class="v" id="kpiB">–</div></div>
          <div class="kpi"><div class="t">Δ % (A vs B)</div><div class="v"><span id="kpiDelta" class="delta">–</span></div></div>
          <div class="kpi"><div class="t">Hora pico</div><div class="v" id="kpiPeak">–</div></div>
        </div>
        <div style="margin-top:12px" class="hint">Consejo: podés arrastrar el Excel exportado directamente desde Looker Studio/GA4. Si hay varias hojas, elegí la correcta en el selector.</div>
      </div>
    </div>
  </div>

  <!-- Libs desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
  const $ = (s)=>document.querySelector(s);
  const fileInput = $('#file');
  const sheetSel  = $('#sheet');
  const chartEl   = $('#chart');
  const btnPng    = $('#download');
  const typeSel   = $('#type');
  const stackedCb = $('#stacked');

  let workbook, chart, parsed;

  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const data = await f.arrayBuffer();
    workbook = XLSX.read(data);
    // Poblar selector de hojas
    sheetSel.innerHTML = '';
    workbook.SheetNames.forEach((name,i)=>{
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name; if(i===0) opt.selected = true; sheetSel.appendChild(opt);
    });
    renderFromSheet(sheetSel.value);
  });

  sheetSel.addEventListener('change', ()=> renderFromSheet(sheetSel.value));
  typeSel.addEventListener('change', ()=> drawChart());
  stackedCb.addEventListener('change', ()=> drawChart());
  btnPng.addEventListener('click', ()=>{
    if(!chart) return;
    const url = chart.toBase64Image();
    const a = document.createElement('a');
    a.href = url; a.download = 'sesiones_por_hora.png'; a.click();
  });

  function renderFromSheet(name){
    const ws = workbook.Sheets[name];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
    parsed = parseGA4HourExport(rows) || parseSimpleHourSheet(rows);
    if(!parsed){
      alert('No pude detectar columnas válidas. Verificá el archivo.');
      return;
    }
    drawChart();
    updateKPIs(parsed);
    btnPng.disabled = false;
  }

  // Parser 1: formato exportado “Sesiones x hora” (como el archivo que me pasaste)
  function parseGA4HourExport(rows){
    // Busco bloques: una fila con [HORA, "% de cambio", %], seguida de dos filas con [ , "dd mmm-dd mmm yyyy", sesiones]
    const reDate = /\d{1,2}\s\w{3}-\d{1,2}\s\w{3}\s\d{4}/i;
    const hours = new Set();
    const seriesA = {}; const seriesB = {};
    let labelA = null, labelB = null;

    for(let i=0;i<rows.length;i++){
      const r = rows[i];
      const c0 = String(r[0]??'').trim();
      const c1 = String(r[1]??'').trim();
      if(/^\d+$/.test(c0) && c1 === '% de cambio'){
        const hr = parseInt(c0,10);
        const r1 = rows[i+1]||[]; const r2 = rows[i+2]||[];
        const d1 = String(r1[1]??'').trim(); const v1 = toInt(r1[2]);
        const d2 = String(r2[1]??'').trim(); const v2 = toInt(r2[2]);
        if(reDate.test(d1) && reDate.test(d2)){
          if(!labelA){ labelA = d1; labelB = d2; }
          seriesA[hr] = v1; seriesB[hr] = v2; hours.add(hr);
        }
      }
    }
    if(hours.size===0) return null;
    const labels = [...hours].sort((a,b)=>a-b);
    return {
      labels,
      seriesLabels:[labelA,labelB],
      datasets:[ labels.map(h=>seriesA[h]||0), labels.map(h=>seriesB[h]||0) ]
    }
  }

  // Parser 2 (fallback): columnas simples Hora / Sesiones (1 serie)
  function parseSimpleHourSheet(rows){
    // Busco cabecera con "Hora" y "Sesiones" en alguna combinación
    let headerIdx = -1; let idxHora=-1, idxSes=-1;
    for(let i=0;i<Math.min(20,rows.length);i++){
      const r = rows[i].map(x=>String(x).toLowerCase());
      idxHora = r.findIndex(v=>v === 'hora');
      idxSes  = r.findIndex(v=>v.includes('sesion'));
      if(idxHora>-1 && idxSes>-1){ headerIdx=i; break; }
    }
    if(headerIdx===-1) return null;
    const labels=[]; const data=[];
    for(let i=headerIdx+1;i<rows.length;i++){
      const r = rows[i]; if(r.length===0) continue;
      const h = r[idxHora]; const v = toInt(r[idxSes]);
      if(h==='' || isNaN(v)) continue;
      labels.push(Number(h)); data.push(v);
    }
    if(labels.length===0) return null;
    return {labels:labels.sort((a,b)=>a-b), seriesLabels:['Sesiones'], datasets:[data]};
  }

  function toInt(x){
    // Soporta formatos con punto/espacios/no-break y comas
    const s = String(x||'').replace(/[^0-9]/g,'');
    return s ? parseInt(s,10) : NaN;
  }

  function drawChart(){
    if(chart) chart.destroy();
    // Asegurar altura fija del lienzo (evita crecimiento infinito)
    const wrap = document.querySelector('.chart-wrap');
    const h = wrap ? Math.max(320, wrap.clientHeight||420) : 420;
    chartEl.height = h;

    const type = typeSel.value;
    const stacked = stackedCb.checked;
    const labels = parsed.labels.map(h=>String(h).padStart(2,'0'));
    // Sanitizar datos: NaN -> 0
    const clean = (arr)=>arr.map(v=>Number.isFinite(Number(v))?Number(v):0);
    const cfg = {
      type,
      data:{
        labels,
        datasets: parsed.datasets.map((arr,i)=>({
          label: parsed.seriesLabels[i]||`Serie ${i+1}`,
          data: clean(arr),
          tension: .3,
          fill: stacked && type==='line' ? true : false,
          borderWidth: 2,
        }))
      },
      options:{
        responsive:true,
        interaction:{mode:'index', intersect:false},
        maintainAspectRatio:false,
        plugins:{
          legend:{labels:{color:'#cfe0ff'}},
          tooltip:{callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${Number(ctx.parsed.y ?? ctx.raw).toLocaleString('es-AR')}` }}
        },
        scales:{ x:{ticks:{color:'#9bb1ff'}, stacked: stacked && type==='bar'}, y:{ticks:{color:'#9bb1ff'}, grid:{color:'rgba(255,255,255,.08)'}, stacked: stacked && type==='bar'} }
      }
    };
    chart = new Chart(chartEl.getContext('2d'), cfg);
  }

  function updateKPIs(p){
    const aTot = p.datasets[0].reduce((s,v)=>s+(v||0),0);
    const bTot = p.datasets[1] ? p.datasets[1].reduce((s,v)=>s+(v||0),0) : 0;
    const delta = bTot>0 ? ((aTot/bTot)-1)*100 : 0;
    const peakIdx = p.datasets[0].indexOf(Math.max(...p.datasets[0]));
    const peakHour = String(p.labels[peakIdx]).padStart(2,'0');
    document.getElementById('kpiA').textContent = aTot.toLocaleString('es-AR');
    document.getElementById('kpiB').textContent = bTot.toLocaleString('es-AR');
    const d = document.getElementById('kpiDelta');
    d.textContent = (isFinite(delta) ? (delta.toFixed(2)+'%') : '–');
    d.className = 'delta ' + (delta>=0? 'positive':'negative');
    document.getElementById('kpiPeak').textContent = `${peakHour}:00`;
  }
  </script>
</body>
</html>
